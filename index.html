<!doctype html>
<html lang="">	
<head>
	<meta charset="utf-8"/>
	<title>Xeno:Lab</title>	
	<meta name="author" content="ejo">
	<link rel="apple-touch-icon" sizes="57x57"         href="https://blog.xenolab.com/theme/images/icons/xenolab-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60"         href="https://blog.xenolab.com/theme/images/icons/xenolab-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72"         href="https://blog.xenolab.com/theme/images/icons/xenolab-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76"         href="https://blog.xenolab.com/theme/images/icons/xenolab-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114"       href="https://blog.xenolab.com/theme/images/icons/xenolab-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120"       href="https://blog.xenolab.com/theme/images/icons/xenolab-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144"       href="https://blog.xenolab.com/theme/images/icons/xenolab-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152"       href="https://blog.xenolab.com/theme/images/icons/xenolab-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180"       href="https://blog.xenolab.com/theme/images/icons/xenolab-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="https://blog.xenolab.com/theme/images/icons/xenolab-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32"    href="https://blog.xenolab.com/theme/images/icons/xenolab-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96"    href="https://blog.xenolab.com/theme/images/icons/xenolab-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16"    href="https://blog.xenolab.com/theme/images/icons/xenolab-16x16.png">
	<link rel="manifest" href="https://blog.xenolab.com/theme/images/icons/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/xenolab-144x144.png">
	<meta name="theme-color" content="#ffffff">
	
	

	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href="https://blog.xenolab.com/theme/css/main.css" type="text/css" />
		

    <link href="https://blog.xenolab.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Xeno:Lab Atom Feed" />
</head>
	
<body>

    <div class="container">
	  
	  <header role="banner">
	    <div class="feeds">
	        <a href="https://blog.xenolab.com/feeds/all.atom.xml" rel="alternate"><img src="https://blog.xenolab.com/theme/images/icons/feed-32px.png" alt="atom feed"/></a>
	    </div>
	      <nav class="pages">
			  <a href="https://blog.xenolab.com/pages/about.html">About</a>
	      </nav>
		<a href="https://blog.xenolab.com" class="title">Xeno:Lab</a>
      </header>
	
	  <div class="wrapper">

		  <div role="main" class="content">



      <article>
        <h1><a href="https://blog.xenolab.com/how-to-write-a-c-program-like-me.html">How To Write a C Program Like&nbsp;Me</a></h1>
        <h3><strong>C is&nbsp;Dumb</strong></h3>
<p>I know, Python and Javascript are what the kids are writing all their
crazy &#8216;apps&#8217; with these days. But don&#8217;t be so quick to dismiss C, it&#8217;s
a capable and concise language that has a lot to offer. If you need
speed, writing in C could be your answer. If you are looking for job
security and the opportunity to learn how to hunt down null pointer
dereferences, C could also be your answer! In this article, I&#8217;ll
explain how to structure a C file and write a C main function that
handles command-line arguments like a&nbsp;champ.</p>
<p><strong>Me</strong>: a crusty <span class="caps">UNIX</span> system programmer.<br>
<strong>You</strong>: someone with an editor, a C compiler and some time to&nbsp;kill.</p>
<p><em>Let&#8217;s do&nbsp;this.</em></p>
<h3><strong>A Boring But Correct C&nbsp;Program</strong></h3>
<p>A C program starts with a <code>main()</code> function, usually kept in a file named <code>main.c</code>.</p>
<div class="highlight"><pre><span></span><span class="cm">/* main.c */</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

<span class="p">}</span>
</pre></div>


<p>This program <strong>compiles</strong> but doesn&#8217;t <strong>do</strong>&nbsp;anything:</p>
<div class="highlight"><pre><span></span>$ gcc main.c
$ ./a.out -o foo -vv 
$
</pre></div>


<p>Correct and&nbsp;boring.</p>
<h3><strong>Main Functions Are&nbsp;Unique</strong></h3>
<p>The <code>main()</code> function is the first function in your program executed
when it begins executing, but it&#8217;s not the first function
executed. The <em>first</em> function is <code>_start()</code> which is typically
provided by the C runtime library, linked in automatically when your
program is compiled. The details are highly dependent on the operating
system and compiler toolchain, so I&#8217;m going to pretend like I didn&#8217;t
mention&nbsp;it.</p>
<p>The <code>main()</code> function has two arguments that traditionally are called
<code>argc</code> and <code>argv</code> and returns a signed integer. Most <span class="caps">UNIX</span> environments
expect programs to return zero on success and negative one on&nbsp;failure.</p>
<table>
 <tr><th>Argument</th><th>Name</th><th>Description</th></tr>
 <tr><td>argc</td><td>Argument Count </td><td>Length of the argument vector.</td></tr>
 <tr><td>argv</td><td>Argument Vector</td><td>Array of character pointers.</td></tr>
</table>

<p>The argument vector, <code>argv</code>, is a tokenized representation of the
commmand line that invoked your program. In the example above, <code>argv</code>
would be a list of the following&nbsp;strings:</p>
<div class="highlight"><pre><span></span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&quot;/path/to/a.out&quot;</span><span class="p">,</span> <span class="s">&quot;-o&quot;</span><span class="p">,</span> <span class="s">&quot;foo&quot;</span><span class="p">,</span> <span class="s">&quot;-vv&quot;</span> <span class="p">];</span>
</pre></div>


<p>The argument vector is guaranteed to always have at least one string in the
first index, <code>argv[0]</code> which is the full path to the program&nbsp;executed. </p>
<h3><strong>Anatomy of a <code>main.c</code> File</strong></h3>
<p>When I write a <code>main.c</code> from scratch, it&#8217;s usually structured like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="cm">/* main.c */</span>
<span class="cm">/* 0 copyright/licensing */</span>
<span class="cm">/* 1 includes */</span>
<span class="cm">/* 2 defines */</span>
<span class="cm">/* 3 external declarations */</span>
<span class="cm">/* 4 typedefs */</span>
<span class="cm">/* 5 global variable declarations */</span>
<span class="cm">/* 6 function prototypes */</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
<span class="cm">/* 7 command-line parsing */</span>
<span class="p">}</span>

<span class="cm">/* 8 function declarations */</span>
</pre></div>


<p>I&#8217;ll talk about each of these numbered sections, except for zero. If you
have to put copyright or licensing text in your source, put it&nbsp;there.</p>
<p>Another thing I won&#8217;t talk about adding to your program is&nbsp;comments.</p>
<div class="highlight"><pre><span></span> &quot;Comments lie.&quot;
 - A cynical but smart and good looking programmer.
</pre></div>


<p>Instead of comments, use meaningful function and variable&nbsp;names.</p>
<p>Appealing to the innate laziness of programmers, once you add comments
you&#8217;ve doubled your maintenance load. If you change or refactor the
code, you need to update or expand the comments. Over time the code
mutates away from anything resembling what the comments&nbsp;describe.</p>
<p>If you have to write comments, do not write about <em>what</em> the code is
doing.  Instead, write about <em>why</em> the code is doing what it&#8217;s doing.
Write comments that you would want to read five years from now when
you&#8217;ve forgotten everything about this code. And the fate of the
world is depending on you. <em>No pressure</em>.</p>
<h3><strong>1&nbsp;Includes</strong></h3>
<p>The first things I add to a <code>main.c</code> file are includes to make a
multitude of standard C library functions and variables available to
my program. The standard C library does lots of things, explore header
files in <code>/usr/include</code> to find out what it can do for&nbsp;you.</p>
<p>The <code>#include</code> string is a <a href="https://en.wikipedia.org/wiki/C_preprocessor">C preprocessor</a> directive that causes
the inclusion of the referenced file in it&#8217;s entirety into the current
file. Header files in C are usually named with a <code>.h</code> extension and
should not contain any executable code; only macros, defines, typedefs
and external variable and function prototypes. The string <code>&lt;header.h&gt;</code>
tells <em>cpp</em> to look for a file called <code>header.h</code> in the system defined
header path, usually <code>/usr/include</code>.</p>
<div class="highlight"><pre><span></span><span class="cm">/* main.c */</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;libgen.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;getopt.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
</pre></div>


<p>This is the minimum set of global includes that I&#8217;ll include by default for the following&nbsp;stuff.</p>
<table>
<tr><th>#include File</th><th>Stuff It Provides</th></tr>
<tr><td>stdio  </td><td> Supplies <span class="caps">FILE</span>, stdin, stdout, stderr and the fprint() family of functions</td></tr>
<tr><td>stdlib </td><td> Supplies malloc(), calloc() and realloc() </td></tr>
<tr><td>unistd </td><td> Supplies EXIT_FAILURE, EXIT_SUCCESS </td></tr>
<tr><td>libgen </td><td> Supplies the basename() function. </td></tr>
<tr><td>errno  </td><td> Defines the external errno variable and all the values it can take on. </td></tr>
<tr><td>string </td><td> Supplies memcpy(), memset() and the strlen() family of functions. </td></tr>
<tr><td>getopt </td><td> Supplies external optarg, opterr, optind and getopt() function. </td></tr>
<tr><td>sys/types</td><td>
Typedef shortcuts like uint32_t and uint64_t </td></tr>
</table>

<h3><strong>2&nbsp;Defines</strong></h3>
<div class="highlight"><pre><span></span><span class="cm">/* main.c */</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

<span class="cp">#define OPTSTR &quot;vi:o:f:h&quot;</span>
<span class="cp">#define USAGE_FMT  &quot;%s [-v] [-f hexflag] [-i inputfile] [-o outputfile] [-h]&quot;</span>
<span class="cp">#define ERR_FOPEN_INPUT  &quot;fopen(input, r)&quot;</span>
<span class="cp">#define ERR_FOPEN_OUTPUT &quot;fopen(output, w)&quot;</span>
<span class="cp">#define ERR_DO_THE_NEEDFUL &quot;do_the_needful blew up&quot;</span>
<span class="cp">#define DEFAULT_PROGNAME &quot;george&quot;</span>
</pre></div>


<p>This doesn&#8217;t make a lot of sense right now, but the <code>OPTSTR</code> define is
where we will define what command-line switches the program will
recommend. Consult the <a href="https://linux.die.net/man/3/getopt"><code>getopt(3)</code></a> manual page to learn how <span class="caps">OPTSTR</span>
will affect <code>getopt()</code><span class="quo">&#8216;</span>s&nbsp;behavior.</p>
<p>The <code>USAGE_FMT</code> define is a <code>printf()</code>-style format string that is
referenced in the <code>usage()</code> function.</p>
<p>I also like to gather string constants as <code>#define</code><span class="quo">&#8216;</span>s in this part of
the file. Collecting them makes it easier to fix spelling, reuse
messages and internationalize messages if&nbsp;required.</p>
<p>Finally, give <code>#define</code>s names with all capital letters to distinguish them
from variable and function names. You can run the words together if you want or
separate words with an underscore, just make sure it&#8217;s all upper&nbsp;case.</p>
<h3><strong>3 External&nbsp;Declarations</strong></h3>
<div class="highlight"><pre><span></span><span class="cm">/* main.c */</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">optarg</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">opterr</span><span class="p">,</span> <span class="n">optind</span><span class="p">;</span>
</pre></div>


<p>An <code>extern</code> declaration brings that name into the namespace of the
current compilation unit ( a.k.a &#8220;file&#8221; ) and allows the program to
access that variable.  Here we&#8217;ve brought in the definitions for three
integer variables and a character pointer.  The <code>opt</code> prefaced
variables are used by the <code>getopt()</code> function and <code>errno</code> is used as
an out-of-band communication channel by the standard C library to
communicate why a function might have&nbsp;failed.</p>
<h3><strong>4&nbsp;Typedefs</strong></h3>
<div class="highlight"><pre><span></span><span class="cm">/* main.c */</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span>           <span class="n">verbose</span><span class="p">;</span>
  <span class="kt">uint32_t</span>      <span class="n">flags</span><span class="p">;</span>
  <span class="kt">FILE</span>         <span class="o">*</span><span class="n">input</span><span class="p">;</span>
  <span class="kt">FILE</span>         <span class="o">*</span><span class="n">output</span><span class="p">;</span>
<span class="p">}</span> <span class="n">options_t</span><span class="p">;</span>
</pre></div>


<p>After external declarations, I like to declare <code>typedefs</code> for
structures, unions and enumerations. Naming <code>typedefs</code> is a religion
all to itself; I strongly prefer a &#8216;_t&#8217; suffix to indicate that the
name is a type. In this example, I&#8217;ve declared <code>options_t</code> as a
<code>struct</code> with four members. <code>C</code> is a white-space neutral programming
language, so I use white space to line up field names in the same
column.  I just like the way it looks. For the pointer declarations, I
prepend the asterisk to the name to make it clear that it&#8217;s a&nbsp;pointer.</p>
<h3><strong>5 Global Variable&nbsp;Declarations</strong></h3>
<p><span class="dquo">&#8220;</span>`c
/<em> main.c </em>/&nbsp;&lt;&#8230;&gt;</p>
<p>int dumb_global_variable =&nbsp;-11;</p>
<div class="highlight"><pre><span></span>Global variables are a bad idea and you should never use them. But if
you have to use a global variable, declare them here and be sure to
give them a default value. Seriously, _don&#39;t use global variables_.

### **6 Function Prototypes**

```c
/* main.c */
&lt;...&gt;

void usage(char *progname, int opt);
int  do_the_needful(options_t *options);
</pre></div>


<p>As you write functions, added after the <code>main()</code> function and not
before, include the function prototypes here. Early C compilers used a
single-pass strategy which meant that every symbol (variable or
function name) you used in your program had to be declared before you
used it. Modern compilers are nearly all multi-pass compilers that
build a complete symbol table before generating code, so the use of
function prototypes is not strictly required. However you sometimes
don&#8217;t get to choose what compiler is used on your code, so write the
function prototypes and drive&nbsp;on.</p>
<p>As a matter of course, I always include a <code>usage()</code> function that
<code>main()</code> calls when it doesn&#8217;t understand something you passed in from
the&nbsp;command-line.</p>
<h3><strong>7 Command-Line&nbsp;Parsing</strong></h3>
<div class="highlight"><pre><span></span><span class="cm">/* main.c */</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>
    <span class="n">options_t</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span> <span class="p">};</span>

    <span class="n">opterr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">OPTSTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">)</span> 
       <span class="k">switch</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">case</span> <span class="sc">&#39;i&#39;</span><span class="o">:</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">))</span> <span class="p">){</span>
                 <span class="n">perror</span><span class="p">(</span><span class="n">ERR_FOPEN_INPUT</span><span class="p">);</span>
                 <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
                 <span class="cm">/* NOTREACHED */</span>
              <span class="p">}</span>
              <span class="k">break</span><span class="p">;</span>

           <span class="k">case</span> <span class="sc">&#39;o&#39;</span><span class="o">:</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">))</span> <span class="p">){</span>
                 <span class="n">perror</span><span class="p">(</span><span class="n">ERR_FOPEN_OUTPUT</span><span class="p">);</span>
                 <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
                 <span class="cm">/* NOTREACHED */</span>
              <span class="p">}</span>    
              <span class="k">break</span><span class="p">;</span>

           <span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span>
              <span class="n">options</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="p">)</span><span class="n">strtoul</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>

           <span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>
              <span class="n">options</span><span class="p">.</span><span class="n">verbose</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>

           <span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
           <span class="k">default</span><span class="o">:</span>
              <span class="n">usage</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">opt</span><span class="p">);</span>
              <span class="cm">/* NOTREACHED */</span>
              <span class="k">break</span><span class="p">;</span>
       <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">do_the_needful</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXIT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">perror</span><span class="p">(</span><span class="n">ERR_DO_THE_NEEDFUL</span><span class="p">);</span>
       <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
       <span class="cm">/* NOTREACHED */</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Ok, that&#8217;s a lot. The purpose of the <code>main()</code> function is to collect the
arguments that the user provides, perform minimal input validation and
then pass the collected arguments to functions that will use them.  In
this example, we declare an <code>options</code> variable initialized with
default values and parse the command-line, updating <code>options</code> as&nbsp;necessary.</p>
<p>The guts of this <code>main()</code> function is a while loop that uses <code>getopt()</code> to
step thru <code>argv</code> looking for command-line options and their arguments
(if any). The <span class="caps">OPTSTR</span> <code>#define</code> earlier in the file is the template
that drives <code>getopt()</code>s behavior.  The <code>opt</code> variable takes on the
character value of any command-line options found by <code>getopt()</code> and the
program&#8217;s response to the detection of the command-line option happens
in the <code>switch</code> statement.</p>
<p>Those of you paying attention will now be questioning why <code>opt</code> is
declared as an 32-bit <code>int</code> but is expected to take on an 8-bit
<code>char</code>?  It turns out <code>getopt()</code> returns an <code>int</code> value that takes on a
negative one when it gets the end of <code>argv</code>, which I check against
<code>EOF</code> or &#8220;End of File&#8221; marker. A <code>char</code> is a signed quantity, but I
like matching variables to their function return&nbsp;values.</p>
<p>When a known command-line option is detected, option specific behavior
happens.  Some options have an argument, specified in <span class="caps">OPTSTR</span> with a
trailing colon. When an option has a argument, the next string in argv
is available to the program via the externally defined variable
<code>optarg</code>. We use <code>optarg</code> to open files for reading and writing or
converting a command-line argument from a string to an integer&nbsp;value.</p>
<p>There are a couple of points for style&nbsp;here:</p>
<ul>
<li>Initialize <code>opterr</code> to zero which disables <code>getopt</code> from emiting a&nbsp;&#8216;?&#8217;.</li>
<li><code>exit(EXIT_FAILURE);</code> or <code>exit(EXIT_SUCCESS);</code> in the middle of <code>main()</code>.</li>
<li><code>/* NOTREACHED */</code> is a lint directive that I&nbsp;like.</li>
<li><code>return EXIT_SUCCESS;</code> at the end of functions that return <code>int</code>.</li>
<li>Explicitly cast implicit type&nbsp;conversions.</li>
</ul>
<p>The command-line signature for this program if it were compiled would
look something&nbsp;like:</p>
<div class="highlight"><pre><span></span>$ ./a.out -h
a.out <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-f hexflag<span class="o">]</span> <span class="o">[</span>-i inputfile<span class="o">]</span> <span class="o">[</span>-o outputfile<span class="o">]</span> <span class="o">[</span>-h<span class="o">]</span>
</pre></div>


<p>In fact, that&#8217;s what <code>usage()</code> will emit to <code>stderr</code> once&nbsp;compiled.</p>
<h3><strong>8 Function&nbsp;Declarations</strong></h3>
<div class="highlight"><pre><span></span><span class="cm">/* main.c */</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>

<span class="kt">void</span> <span class="n">usage</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">progname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">USAGE_FMT</span><span class="p">,</span> <span class="n">progname</span><span class="o">?</span><span class="nl">progname</span><span class="p">:</span><span class="n">DEFAULT_PROGNAME</span><span class="p">);</span>
   <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
   <span class="cm">/* NOTREACHED */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">do_the_needful</span><span class="p">(</span><span class="n">options_t</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
     <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">||</span> <span class="o">!</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">errno</span> <span class="o">=</span> <span class="n">ENOENT</span><span class="p">;</span>
     <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* XXX do needful stuff */</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>And now, finally, we write functions that aren&#8217;t boilerplate. In this
example, function <code>do_the_needful()</code> accepts a pointer to an
<code>options_t</code> structure. We validate that the <code>options</code> pointer is not
<span class="caps">NULL</span> and then go on to validate the <code>input</code> and <code>output</code> structure
members.  We return EXIT_FAILURE if either test fails, and signal to
the caller a general reason by setting the external global variable
<code>errno</code> to a conventional error code. The convenience function
<code>perror()</code> can be used by the caller to emit human-readable-ish error
messages based on the value of <code>errno</code>.</p>
<p>Functions should almost always validate their input in some way. If
full validation is expensive, try to do it once and treat the
validated data as immutable. In the <code>usage()</code> function, we validate
the <code>progname</code> argument using a conditional assignment in the
<code>fprintf()</code> call. The <code>usage()</code> function is going to exit anyway, so I
don&#8217;t bother setting <code>errno</code> or making a big stink about using a
correct program&nbsp;name.</p>
<p>The big class of errors we are trying to avoid here is dereferencing a
<span class="caps">NULL</span> pointer. This will cause the operating system to send a special
signal to our process called <code>SYSSEGV</code> which results in unavoidable
death. The last thing your users want to see is a crash due to
<span class="caps">SYSSEGV</span>. It&#8217;s much better to catch a <span class="caps">NULL</span> pointer so you can emit
better error messages and shutdown the program&nbsp;gracefully.</p>
<p>Some people complain about having multiple <code>return</code> statements in a
function body. They make arguments about continuity of control-flow
and other stuff. Honestly, if the something goes wrong in the middle
of a function, it&#8217;s a good time to return an error condition. Writing
a ton of nested <code>if</code> statements just have one return is never a &#8220;good&nbsp;idea&#8221;™.</p>
<p>Finally, if you write a function that takes four or more arguments
consider bundling those arguments in a structure and passing a pointer
to the structure. This makes the function signatures simpler, making
them easier to remember and not screw up when you call them later. It
also makes calling the function slightly faster since fewer things
need to be copied into the function&#8217;s stack frame. In practice, this
will only become a consideration if the function is called millions or
billions of times. Don&#8217;t worry about it if that doesn&#8217;t make&nbsp;sense.</p>
<h3><strong>Wait, You Said No&nbsp;Comments!?!!</strong></h3>
<p>In the <code>do_the_needful()</code> function I wrote a specific type of comment
that is designed to be a placeholder rather than document the&nbsp;code.</p>
<div class="highlight"><pre><span></span><span class="cm">/* XXX do needful stuff */</span>
</pre></div>


<p>When you are in the zone, sometimes you don&#8217;t want to stop and write
some particularly gnarly bit of code. You&#8217;ll come back and do it
later, just not now. That&#8217;s where I&#8217;ll leave myself a little
breadcrumb.  I insert a commment with a &#8216;<span class="caps">XXX</span>&#8217; prefix and a short
remark describing what needs doing. Later on when I have more time,
I&#8217;ll grep thru source looking for <span class="caps">XXX</span>. It doesn&#8217;t matter what you
use, just make sure it&#8217;s not likely to show up in your code base
in another context; function name or variable for&nbsp;instance.</p>
<h3><strong>Putting It All&nbsp;Together</strong></h3>
<p>Ok, this progam <em>still</em> does almost nothing when you compile and run
it. But now you have a solid skeleton to build your own command-line
parsing <code>C</code> programs.</p>
<div class="highlight"><pre><span></span><span class="cm">/* main.c - the complete listing */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;libgen.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;getopt.h&gt;</span><span class="cp"></span>

<span class="cp">#define OPTSTR &quot;vi:o:f:h&quot;</span>
<span class="cp">#define USAGE_FMT  &quot;%s [-v] [-f hexflag] [-i inputfile] [-o outputfile] [-h]&quot;</span>
<span class="cp">#define ERR_FOPEN_INPUT  &quot;fopen(input, r)&quot;</span>
<span class="cp">#define ERR_FOPEN_OUTPUT &quot;fopen(output, w)&quot;</span>
<span class="cp">#define ERR_DO_THE_NEEDFUL &quot;do_the_needful blew up&quot;</span>
<span class="cp">#define DEFAULT_PROGNAME &quot;george&quot;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">errno</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="o">*</span><span class="n">optarg</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">opterr</span><span class="p">,</span> <span class="n">optind</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="kt">int</span>           <span class="n">verbose</span><span class="p">;</span>
  <span class="kt">uint32_t</span>      <span class="n">flags</span><span class="p">;</span>
  <span class="kt">FILE</span>         <span class="o">*</span><span class="n">input</span><span class="p">;</span>
  <span class="kt">FILE</span>         <span class="o">*</span><span class="n">output</span><span class="p">;</span>
<span class="p">}</span> <span class="n">options_t</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">dumb_global_variable</span> <span class="o">=</span> <span class="o">-</span><span class="mi">11</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">usage</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">progname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opt</span><span class="p">);</span>
<span class="kt">int</span>  <span class="nf">do_the_needful</span><span class="p">(</span><span class="n">options_t</span> <span class="o">*</span><span class="n">options</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>
    <span class="n">options_t</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span> <span class="p">};</span>

    <span class="n">opterr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">OPTSTR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">)</span> 
       <span class="k">switch</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">case</span> <span class="sc">&#39;i&#39;</span><span class="o">:</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">))</span> <span class="p">){</span>
                 <span class="n">perror</span><span class="p">(</span><span class="n">ERR_FOPEN_INPUT</span><span class="p">);</span>
                 <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
                 <span class="cm">/* NOTREACHED */</span>
              <span class="p">}</span>
              <span class="k">break</span><span class="p">;</span>

           <span class="k">case</span> <span class="sc">&#39;o&#39;</span><span class="o">:</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">))</span> <span class="p">){</span>
                 <span class="n">perror</span><span class="p">(</span><span class="n">ERR_FOPEN_OUTPUT</span><span class="p">);</span>
                 <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
                 <span class="cm">/* NOTREACHED */</span>
              <span class="p">}</span>    
              <span class="k">break</span><span class="p">;</span>

           <span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span>
              <span class="n">options</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="p">)</span><span class="n">strtoul</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>

           <span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>
              <span class="n">options</span><span class="p">.</span><span class="n">verbose</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
              <span class="k">break</span><span class="p">;</span>

           <span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
           <span class="k">default</span><span class="o">:</span>
              <span class="n">usage</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">opt</span><span class="p">);</span>
              <span class="cm">/* NOTREACHED */</span>
              <span class="k">break</span><span class="p">;</span>
       <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">do_the_needful</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXIT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">perror</span><span class="p">(</span><span class="n">ERR_DO_THE_NEEDFUL</span><span class="p">);</span>
       <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
       <span class="cm">/* NOTREACHED */</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usage</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">progname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="n">USAGE_FMT</span><span class="p">,</span> <span class="n">progname</span><span class="o">?</span><span class="nl">progname</span><span class="p">:</span><span class="n">DEFAULT_PROGNAME</span><span class="p">);</span>
   <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
   <span class="cm">/* NOTREACHED */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">do_the_needful</span><span class="p">(</span><span class="n">options_t</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
     <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">||</span> <span class="o">!</span><span class="n">options</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">errno</span> <span class="o">=</span> <span class="n">ENOENT</span><span class="p">;</span>
     <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="cm">/* XXX do needful stuff */</span>

   <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
      </article>

      <hr />

        <div>
          <h3>Last posts</h3>
          <ol class="archive">
    


      <li>
<a href="https://blog.xenolab.com/using-pelican-to-publish-your-blog-on-github.html" rel="bookmark" title="Permalink to Using Pelican to Publish Your Blog on&nbsp;GitHub">Using Pelican to Publish Your Blog on&nbsp;GitHub</a>
  <time datetime="2018-10-05T00:00:00-05:00" pubdate>Friday, 05 Oct 2018</time>
<p class="tags">tags: <a href="https://blog.xenolab.com/tag/python.html">python</a><a href="https://blog.xenolab.com/tag/blog.html">blog</a><a href="https://blog.xenolab.com/tag/pelican.html">pelican</a><a href="https://blog.xenolab.com/tag/github.html">GitHub</a></p></a>      </li>


      <li>
<a href="https://blog.xenolab.com/a-short-primer-on-assembers-compilers-and-interpreters.html" rel="bookmark" title="Permalink to A Short Primer on Assembers, Compilers and&nbsp;Interpreters">A Short Primer on Assembers, Compilers and&nbsp;Interpreters</a>
  <time datetime="2018-10-03T00:00:00-05:00" pubdate>Wednesday, 03 Oct 2018</time>
<p class="tags">tags: <a href="https://blog.xenolab.com/tag/computer.html">computer</a><a href="https://blog.xenolab.com/tag/programming.html">programming</a><a href="https://blog.xenolab.com/tag/history.html">history</a></p></a>      </li>


          </ol>
        </div>

		  </div>	
		  
		  <div class="sidebar">

	        <nav>
	          <h2>Categories</h2>
	          <ul>
	              <li ><a href="https://blog.xenolab.com/category/howto.html">HowTo</a></li>
	              <li ><a href="https://blog.xenolab.com/category/primers.html">Primers</a></li>
	          </ul>
	        </nav>



		  </div>

	  </div>

	  <footer>


	  </footer>	

	</div>
	

</body>
</html>